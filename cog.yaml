build:
  gpu: true
  cuda: "11.8"
  system_packages:
    - "libgl1-mesa-glx"
    - "libglib2.0-0"
    - "libsm6"
    - "libxext6"
    - "libxrender-dev"
    - "libgomp1"
    - "wget"
    - "curl"
    - "git"
    - "cmake"
    - "build-essential"
    - "libboost-all-dev"
    - "pkg-config"
  python_version: "3.10"
  python_packages:
    - "torch==2.0.1"
    - "torchvision==0.15.2"
    - "torchaudio==2.0.2"
    - "torchtext==0.15.2"
    - "xformers==0.0.20"
    - "accelerate"
    - "transformers"
    - "diffusers"
    - "opencv-python"
    - "pillow"
    - "numpy"
    - "requests"
    - "aiohttp"
    - "pyyaml"
    - "Pillow"
    - "scipy"
    - "tqdm"
    - "psutil"
    - "fastapi==0.104.1"
    - "pydantic==2.4.2"
    - "insightface"
    - "onnxruntime-gpu"
    - "opencv-contrib-python"
    - "timm"
    - "safetensors"
    - "controlnet-aux"
  run:
    - "mkdir -p /src"
    - "cd /src && git clone https://github.com/comfyanonymous/ComfyUI.git"
    - "cd /src/ComfyUI && git checkout master && git pull"
    - "cd /src/ComfyUI && pip install -r requirements.txt"
    - "echo 'Installing custom nodes...'"
    - "cd /src/ComfyUI/custom_nodes && git clone https://github.com/lldacing/ComfyUI_PuLID_Flux_ll.git"
    - "cd /src/ComfyUI/custom_nodes/ComfyUI_PuLID_Flux_ll && pip install -r requirements.txt"
    - "cd /src/ComfyUI/custom_nodes && git clone https://codeberg.org/Gourieff/comfyui-reactor-node.git"
    - "cd /src/ComfyUI/custom_nodes/comfyui-reactor-node && pip install -r requirements.txt"
    - "cd /src/ComfyUI/custom_nodes && git clone https://github.com/Fannovel16/comfyui_controlnet_aux.git"
    - "cd /src/ComfyUI/custom_nodes/comfyui_controlnet_aux && pip install -r requirements.txt"
    - "cd /src/ComfyUI/custom_nodes && git clone https://github.com/kijai/ComfyUI-FluxTrainer.git"
    - "echo 'Installing packages that require cmake compilation...'"
    - "pip install dlib"
    - "pip install face-recognition"
    - "echo 'Creating model directories...'"
    - "mkdir -p /src/ComfyUI/models/{checkpoints,diffusion_models,unet,vae,clip/t5,controlnet/FLUX,pulid,insightface/models/antelopev2,facerestore_models,facexlib}"
    - "echo 'Downloading only essential runtime models...'"
    - "wget -O /src/ComfyUI/models/vae/ae.safetensors https://huggingface.co/ffxvs/vae-flux/resolve/main/ae.safetensors"
    - "wget -O /src/ComfyUI/models/clip/clip_l.safetensors https://huggingface.co/comfyanonymous/flux_text_encoders/resolve/main/clip_l.safetensors"
    - "wget -O /src/ComfyUI/models/insightface/models/antelopev2/inswapper_128.onnx https://huggingface.co/ezioruan/inswapper_128.onnx/resolve/main/inswapper_128.onnx"
    - "echo 'All other models (~26GB total) downloaded at runtime for minimal Docker image'"
    - "echo 'Aggressive cleanup for minimal image size...'"
    - "pip cache purge"
    - "apt-get clean"
    - "rm -rf /var/lib/apt/lists/*"
    - "rm -rf /tmp/*"
    - "rm -rf /root/.cache"
    - "find /src -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true"
    - "find /src -name '*.pyc' -delete 2>/dev/null || true"
    - "find /src -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true"
    - "find /usr/local -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true"
    - "find /usr/local -name '*.pyc' -delete 2>/dev/null || true"
    - "echo 'Final optimized image disk usage:'"
    - "df -h"
    - "du -sh /src/ComfyUI"

predict: "predict.py:Predictor" 